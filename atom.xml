<?xml version="1.0" encoding="utf-8"?> <feed xmlns="http://www.w3.org/2005/Atom"><title><![CDATA[Gabe Evans]]></title><link href="http://ga.be/atom.xml" rel="self"/><link href="http://ga.be/"/> <updated>2013-10-08T14:44:31-07:00</updated> <id>http://ga.be/</id> <author> <name><![CDATA[Gabe Evans]]></name> </author> <generator uri="http://octopress.org/">Octopress</generator> <entry><title type="html"><![CDATA[Fixing RubyGems SSL Issues (Certificate Verify Failed)]]></title><link href="http://ga.be/blog/2013/10/02/fixing-rubygems-ssl-issues-certificate-verify-failed/"/> <updated>2013-10-02T13:58:00-07:00</updated> <id>http://ga.be/blog/2013/10/02/fixing-rubygems-ssl-issues-certificate-verify-failed</id> <content type="html"><![CDATA[<p>Can you guess what took a significant portion of my time debugging this afternoon? I was going about my usual business, cloning a new project and bundling when I encountered this deliciously vague error:</p><pre><code>Gem::RemoteFetcher::FetchError: SSL_connect returned=1 errno=0 state=SSLv3
read server certificate B: certificate verify failed
(https://s3.amazonaws.com/production.s3.rubygems.org/gems/builder-3.1.4.gem)
An error occurred while installing builder (3.1.4), and Bundler cannot
continue. Make sure that `gem install builder -v '3.1.4'` succeeds
before bundling.
</code></pre><p><em>I haven’t run into this one before</em>, I thought to myself. I hadn’t updated any packages, changed any configurations, or done anything that could be the obvious cause of this issue. My first thought was to blame the repository I had cloned. Unfortunately, when I switched to another project I was greeted with the same message.</p><p>I obviously tried what bundler recommended and ran <code>gem install builder -v '3.1.4'</code>, fully expecting the same message (as that’s usually how it goes). My expectations were met.</p><p>Being fairly experienced with Linux and OSX, I’m used to dealing with outdated SSL certificate bundles and explicitly specifying the path to OpenSSL. I figured it was a simple build issue or that the version of RubyGems I was using just needed a quick update. I was wrong:</p><pre><code>$ gem update
Updating installed gems
Nothing to update

$ gem update --system
Latest version currently installed. Aborting.
</code></pre><h2>The <em>Worst</em> Solution</h2><p>I was surprised by the number of Stack Overflow answers suggesting that I change my <code>Gemfile</code>’s <code>source</code> line to <code>http://rubygems.org</code> (non-SSL). I considered it for a moment but couldn’t force myself into doing it.</p><h2>The Solution</h2><blockquote><p>Insanity: doing the same thing over and over again and expecting different results.</p><p>(Albert Einstein)</p></blockquote><pre><code>$ bundle
Fetching source index from https://rubygems.org/
Could not verify the SSL certificate for https://rubygems.org/.
There is a chance you are experiencing a man-in-the-middle attack, but most
likely your system doesn't have the CA certificates needed for verification.
For information about OpenSSL certificates, see bit.ly/ruby-ssl. To connect
without using SSL, edit your Gemfile sources and change 'https' to 'http'.
</code></pre><p>The entertaining part of development is that you sometimes <em>do</em> get different results when doing the same thing over and over again. Making a quick visit to <a href="http://bit.ly/ruby-ssl">http://bit.ly/ruby-ssl</a> gave me something to go off of.</p><pre><code>$ ruby -ropenssl -e 'puts OpenSSL::X509::DEFAULT_CERT_FILE'
/usr/local/etc/openssl/cert.pem
</code></pre><p>When running the above in a terminal, I was able to see the exact location Ruby was getting its SSL certificate authority bundle. Mine was outdated which was causing the errors (when connecting to RubyGems.org, it would fail epicly, not being able to verify the authenticity of its certificate).</p><p>One dirty hack and all was back to normal:</p><pre><code>$ curl http://curl.haxx.se/ca/cacert.pem &gt; /usr/local/etc/openssl/cert.pem
</code></pre><h2>TL;DR – The Solution</h2><p>I’m not completely satisfied and I’m positive I’ll have to reference notes again in the future. Regardless, the following works:</p><h3>Plan A: Homebrew/OSX</h3><p>Let Homebrew keep everything updated for you:</p><pre><code>rm $(ruby -ropenssl -e 'puts OpenSSL::X509::DEFAULT_CERT_FILE') &amp;&amp; \
brew install curl-ca-bundle &amp;&amp; ln -s /usr/local/opt/curl-ca-bundle/share/ca-bundle.crt \
$(ruby -ropenssl -e 'puts OpenSSL::X509::DEFAULT_CERT_FILE') \
echo 'export SSL_CERT_FILE=/usr/local/opt/curl-ca-bundle/share/ca-bundle.crt' &gt;&gt; ~/.bash_profile
</code></pre><p>The above commands will remove the old CA bundle, install <code>curl-ca-bundle</code>, a package containing the latest CA bundle directly from Mozilla, link it back to the old location, and set <code>$SSL_CERT_FILE</code> within your terminal for future use.</p><h3>Plan B: Everything Else</h3><pre><code>$ curl http://curl.haxx.se/ca/cacert.pem &gt; $(ruby -ropenssl -e 'puts OpenSSL::X509::DEFAULT_CERT_FILE')
</code></pre><p>The above command feels more like a band-aid than anything else but it will replace the outdated CA bundle with the latest one available from the cURL maintainers. My only issue (and at the same time, it’s a bit of inception): Why can’t we access the bundle over SSL to get the certificates needed to verify the SSL connection?</p> ]]></content> </entry> </feed>